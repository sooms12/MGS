<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="description" content="Ogani Template">
  <meta name="keywords" content="Ogani, unica, creative, html">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>장바구니</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;600;900&display=swap" rel="stylesheet">

  <!-- Css Styles -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.min.css" type="text/css">
  <link rel="stylesheet" href="/css/elegant-icons.css" type="text/css">
  <link rel="stylesheet" href="/css/nice-select.css" type="text/css">
  <link rel="stylesheet" href="/css/jquery-ui.min.css" type="text/css">
  <link rel="stylesheet" href="/css/owl.carousel.min.css" type="text/css">
  <link rel="stylesheet" href="/css/slicknav.min.css" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="shortcut icon" href="/img/banner/파비콘.png" type="image/x-icon">
</head>
<body>
<!-- Page Preloder -->
<div id="preloder">
  <div class="loader"></div>
</div>

<!-- Header Section Begin -->
<header class="header">
  <div class="header__top">
    <div class="container">
      <div class="row">
        <div class="col-lg-6 col-md-6">
          <div class="header__top__left">

          </div>
        </div>
        <div class="col-lg-6">
          <div class="header__top__right">
            <div class="header__top__right__social" th:if="${session.loginId ne null}">
              <a id="mypage"><i class=""></i>내정보</a>
            </div>

            <!-- 회원목록 -->
            <div class="header__top__right__social" th:if="${session.loginId eq 'admin'}">
              <a id="mList"><i class=""></i>회원목록</a>
            </div>

            <div class="header__top__right__language" th:if="${session.loginId eq null}">
              <div>로그인/회원가입</div>
              <span class="arrow_carrot-down"></span>
              <ul>
                <li>
                  <a href="/loginForm" th:if="${session.loginId eq null}">
                    <i class="fa fa-user"> </i>로그인</a>
                </li>
                <li>
                  <a href="/joinForm" data-bs-toggle="modal" data-bs-target="#myModal"
                     th:if="${session.loginId eq null}">
                    <i class=" fa fa-info-circle"></i>회원가입</a>
                </li>
              </ul>
            </div>

            <div class="modal" id="myModal">
              <div class="modal-dialog">
                <div class="modal-content">

                  <!-- Modal Header -->
                  <div class="modal-header">
                    <h4 class="modal-title">회원가입</h4>
                    <span type="button" class="icon_close" data-bs-dismiss="modal"></span>
                  </div>

                  <!-- Modal body -->
                  <div class="modal-body" style="text-align: center">
                    <a type="button" id="join"><img src="/img/이메일가입.png"/></a>
                    <a type="button" id="kLogin"><img src="/img/카카오로그인.png"/></a>
                  </div>

                  <!-- Modal footer -->
                  <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">취소</button>
                  </div>

                </div>
              </div>
            </div>

            <div class="header__top__right__auth" th:if="${session.loginId ne null}">
              <a id="logout"><i class="fa fa-user"></i>로그아웃</a>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-lg-3">
        <div class="header__logo">
          <a href="/"><img src="/img/공구의숲 로고3.png" alt="공구의숲 로고"></a>
        </div>
      </div>
      <div class="col-lg-6">
        <nav class="header__menu">
          <ul>
            <li><a id="sList">전체상품</a></li>
            <li><a id="request">상품신청</a></li>
            <li><a class="psList">인원조사참여</a></li>
            <li th:if="${session.loginId eq 'admin'}"><a href="">관리자메뉴</a>
              <ul class="header__menu__dropdown">
                <li><a id="cList">회사목록</a></li>
                <li><a id="pList">상품목록</a></li>
                <li><a id="rqList">신청물품 목록</a></li>
                <li><a class="psList">인원조사 목록</a></li>
              </ul>
            </li>

          </ul>
        </nav>
      </div>
      <div class="col-lg-3">
        <div class="header__cart">
          <ul>
            <li th:if="${session.loginId ne null}"><a id="likeList"><i class="fa fa-heart" style="text-align: center"><p>찜한상품</p></i></a></li>
            <li><a id="ctlist"><i class="fa fa-shopping-bag" style="text-align: center"><p>장바구니</p></i></a></li>
            <li><a href="/csList"><i class="fa fa-phone" style="text-align: center"><p>고객센터</p></i></a></li>
          </ul>
          <div class="header__cart__price"><span></span></div>
        </div>
      </div>
    </div>
    <div class="humberger__open">
      <i class="fa fa-bars"></i>
    </div>
  </div>
</header>
<!-- Header Section End -->

<!-- Breadcrumb Section Begin -->
<div style="margin-top: 50px"></div>

<section class="breadcrumb-section set-bg" data-setbg="/img/동숲바닥.png" style="height: 100px">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center">
        <div class="breadcrumb__text">
          <h2>장바구니</h2>
          <div class="breadcrumb__option">
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<br>
<!-- Breadcrumb Section End -->

<!-- Shoping Cart Section Begin -->
<section class="shoping-cart spad">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="shoping__cart__table">
          <table>
            <thead>
            <tr>
              <th class="shoping__product">상품명</th>
              <th>판매가</th>
              <th>수량</th>
              <th>배송비</th>
              <th>소계</th>
            </tr>
            </thead>

            <tbody>
            <!--        장바구니 목록       -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-12">
        <div class="shoping__cart__btns">
          <!--                    <a href="#" class="primary-btn cart-btn">쇼핑계속하기</a>-->
          <!--                    <a href="#" class="primary-btn cart-btn cart-btn-right"><span class="icon_loading"></span>-->
          <!--                        Upadate Cart</a>-->
        </div>
      </div>
      <div class="col-lg-6">
        <div class="shoping__continue">
          <div class="shoping__discount">
            <!--                        <h5>Discount Codes</h5>-->
            <!--                        <form action="#">-->
            <!--                            <input type="text" placeholder="Enter your coupon code">-->
            <!--                            <button type="submit" class="site-btn">APPLY COUPON</button>-->
            <!--                        </form>-->
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="shoping__checkout">
          <h5>전체합계</h5>
          <ul>
            <li>배송비<span id="orderp"></span></li>
            <li>전체주문금액<span id="totalp"></span></li>
          </ul>
          <button type="button" class="btn btn-success" id="orderButton" >주문하기</button>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Shoping Cart Section End -->

<!-- Footer 시작했다~ -->
<footer class="footer spad">
  <div class="col-lg-12">
    <div class="footer__widget">
      <h6></h6>
      <a><a href="#">회사소개</a></a>&nbsp;&nbsp;
      <a><a href="#">이용약관</a></a>&nbsp;&nbsp;
      <a><a href="#">개인정보처리방침</a></a>&nbsp;&nbsp;
      <a><a href="#">FAQ</a></a>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="footer__about">
          <div class="footer__about__logo">
            <a href="/"><img src="/img/공구의숲 로고3.png" alt=""></a>
          </div>

        </div>
      </div>
      <div class="col-lg-4 col-md-6 col-sm-6 offset-lg-1">
        <div class="footer__widget">
          <h5 class="mb-12"><b class="fs-14px">고객센터 1234-5678</b></h5>
          <a>평일 AM 10:00 ~ PM 5:00</p></a>
          <a>점심시간 PM 12:30 ~ PM 13:30</p></a>
          <a>주말 및 공휴일 휴무</p></a>
          <a>계좌번호 NH농협 000-0000-000-00</p></a>
          <a>문의메일 Kimmango@naver.com</p></a>
        </div>
      </div>
      <div class="col-lg-4 col-md-12">
        <div class="footer__widget">
          <a>대표자.김망고</a></br>
          <a>사업자등록번호.1234567890</a></br>
          <a>주소. 인천광역시 미추홀구 한나루로 453</a></br>
          <a>TEL.032-1234-5678</a></br>
          <a>Email. hello@colorlib.com</a>

        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-12">
        <div class="footer__copyright">
          <div class="footer__copyright__text"><p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
            Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="fa fa-heart" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank">Colorlib</a>
            <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. --></p></div>

        </div>
      </div>
    </div>
  </div>
</footer>
<!-- Footer 끝났다~ -->

<!-- Js Plugins -->
<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.nice-select.min.js"></script>
<script src="/js/jquery-ui.min.js"></script>
<script src="/js/jquery.slicknav.js"></script>
<script src="/js/mixitup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/main.js"></script>

</body>
<script src="https://code.jquery.com/jquery-3.6.4.js" integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E="
        crossorigin="anonymous"></script>
<script>

  let id = "[[${session.loginId}]]";

  // 회원가입
  $('#join').click(function () {
    location.href = "/joinForm";
  });

  // 카카오로그아웃
  $('#klogout').click(function () {
    location.href = "/klogout";
  });

  // 회원목록
  $('#mList').click(function () {
    location.href = "/mList";
  });

  // 로그인
  $('#login').click(function () {
    location.href = "/loginForm";
  });

  // 내정보
  $('#mypage').click(function () {
    location.href = "/mView/[[${session.loginId}]]";
  });

  // 찜목록
  $('#likeList').click(function () {
      location.href = "/likeList/[[${session.loginId}]]";
  });

  // 장바구니 목록
  $('#ctlist').click(function () {
    if (id == "") {
      alert('로그인 후 이용해주세요!')
      location.href = ""
    }
    if (id != "") {
      location.href = "/ctlist";
    }
  });

  // 로그아웃
  $('#logout').click(function () {
    location.href = "/mLogout";
  });

  // 신청페이지
  $('#request').click(function () {
    location.href = "/requestForm";
  });

  // 신청목록
  $('#rqList').click(function () {
    location.href = "/rqList";
  });

  // 회사목록
  $('#cList').click(function () {
    location.href = "/cList";
  });

  // 상품목록
  $('#pList').click(function () {
    location.href = "/pList";
  });

  // 판매목록
  $('#sList').click(function () {
    location.href = "/sList";
  });

  $('#request').click(function () {
    if (id == "") {
      alert('로그인 후 이용해주세요!')
      location.href = "redirect:/loginForm"
    }else {
      location.href = "requestForm";
    }
  });

  $('#rqList').click(function () {
    location.href = "/rqList";
  });

  $('.psList').click(function () {
    location.href = "/psList";
  });

  $('.psList').click(function () {
    if (id == "") {
      alert('로그인 후 이용해주세요!')
      location.href = "redirect:/loginForm"
    }else {
      location.href = "/psList";
    }
  });

  // 카카오인증버튼
  $('#kLogin').click(function () {
    location.href = "";
  });


  let mId = `[[${session.loginId}]]`;
  console.log(`[[${session.loginId}]]`);



  $.ajax({
    type: "POST",
    url: "/cctlist",
    data: {"mId": mId},
    dataType: "json",
    success: function (list) {
      console.log(list);
      cartlist(list);
    },
    error: function () {
      alert('장바구니 목록 실패');
    }
  });

  let row = "";
  let totalCartPrice = 0;
  // 장바구니 목록에 출력하는 함수
  function cartlist(list) {
    let has3000 = false;
    for (let i = 1; i <= list.length; i++) {
      let item = list[i - 1];

      let ctNum = item.ctNum;
      let snum = item.sNum;


      // 총 가격 계산을 위해 각 상품의 가격과 수량을 곱하여 총 가격을 계산
      let productTotalPrice = item.pPrice * item.cCount;
      totalCartPrice += productTotalPrice;
      let productPrice = item.pPrice * item.cCount

      if (item.sdPrice === 3000) { // 3000원 상품을 찾았을 경우
        has3000 = true;
      }


      row += `<tr>`; // <tr>로 시작해야 함

      row += `<td  class="shoping__cart__item"><img src='/product/${item.pmPicName}' width="100px" height="100px"><h5>${item.pName}</h5></td>`;

      row += `<td  class="shoping__cart__price">${item.pPrice} 원</td>`;

      row += `<td class="shoping__cart__quantity"><div class="quantity"><div class="pro-qty"><input type="text" value="${item.cCount}"></div></div></td>`;

      row += `<td class="shoping__cart__total"> ${item.sdPrice}원 </td>`;

      row += `<td class="shoping__cart__total"> ${productPrice} 원</td>`;

      row += '<td class="shoping__cart__item__close"><span onclick="ctDelete(' + ctNum + ')" class="icon_close"></span></td>';

      row += `</tr>`;

    }
    const orderp = document.querySelector('#orderp');
    if (has3000) { // 3000원 상품이 있을 경우
      orderp.innerText = '3000원';
    } else { // 3000원 상품이 없을 경우
      orderp.innerText = '무료';
    }
    $('table tbody').empty();
    $('table tbody').append(row);
    let orderPrice = orderp.innerText; // 현재 orderp의 값을 읽어옴
    if (orderPrice === '무료') {
      orderPrice = 0; // '무료'인 경우 0원으로 설정
    } else {
      orderPrice = parseInt(orderPrice); // 문자열을 정수형으로 변환
    }
    const totalp = document.querySelector('#totalp');

// 총 가격과 orderp를 더하여 출력
    totalp.innerText = totalCartPrice + orderPrice + '원';

  }

  // 삭제 버튼 클릭 이벤트
  function ctDelete(ctNum){
    if(confirm('정말 삭제하시겠습니까?')) {
      console.log('###############');
      console.log(ctNum);
      let data = {
        mId: mId,
        ctNum: ctNum
      };
      $.ajax({
        type: "POST",
        url: "/deleteCartItem",
        data: data,
        dataType: "json",
        success: function (response) {
          console.log(response);
          list = response;
          // 장바구니 목록을 다시 로드해서 갱신
          alert('삭제했습니다.');
          location.href = "/ctlist";
        },
        error: function () {
          console.error("삭제하지 못했습니다!");
        }
      });
    } else{
      alert('취소했습니다.')
    }
  }

  // 장바구니 페이지에서 선택한 상품 정보를 저장하는 배열
  let selectedProducts = [];

  // 주문하기 버튼 클릭 이벤트
  $('#orderButton').click(function () {
    // 선택된 상품 정보를 selectedProducts 배열에 추가
    $('table tbody').each(function () {
      let pName = $(this).find('td:first-child').text();
      let pPrice = parseInt($(this).find('td:nth-child(2)').text().replace('원', ''), 10);
      let cCount = parseInt($(this).find('td:nth-child(3)').text().replace('개', ''), 10);
      let productPrice = parseInt($(this).find('td:nth-child(5)').text().replace('원', ''), 10);

      let selectedProduct = {
        pName: pName,
        pPrice: pPrice,
        cCount: cCount,
        productPrice: productPrice
      };

      selectedProducts.push(selectedProduct);
    });

    // 선택된 상품 정보를 로컬 스토리지에 저장
    localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));

    // 주문 페이지로 이동
    location.href = "/kakaopay"; // 실제 주문 페이지
  });

</script>
</html>